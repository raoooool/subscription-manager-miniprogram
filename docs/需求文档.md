## 1. 背景与目标

Pandora 已经长时间未维护，用户缺乏可靠的订阅管理工具。「瓜的订阅管理」旨在提供一个轻量、直观且美观的订阅资产盘点与提醒服务，帮助用户随时掌握各项付费情况，降低遗忘续费带来的浪费。

**目标：**

- 30 秒内完成全部订阅导入。
- 提供微信生态内的高频提醒能力。
- 支持主流国内外订阅服务，并允许自定义。
- 保持极简却有审美张力的界面。

## 2. 用户画像与关键场景

| 角色            | 需求                   | 痛点                     |
| --------------- | ---------------------- | ------------------------ |
| 订阅重度用户    | 快速录入、分类、提醒   | 现有工具不更新、数据不全 |
| 自由职业者/学生 | 控制预算、避免自动续费 | 忘记取消订阅导致浪费     |
| 家庭共享        | 家庭成员订阅统一管理   | 各自续费信息分散         |

**核心场景：**

1. 新用户首次进入，导入常用订阅模板 + 手动添加。
2. 日常查看订阅列表，按到期时间或价格排序。
3. 到期前（设定提前 X 天）收到微信提醒。
4. 修改订阅价格或计划，查看历史开销汇总。

## 3. 范围与原则

- **包含**：订阅项 CRUD、提醒配置、数据统计、微信账号登录/同步。
- **设计原则**：首屏即见全貌、操作不超过两层、默认安全（数据不出境）。

## 4. UX / UI 设计要点

- 首页以卡片或分组列表形式展示订阅，突出「即将到期」「本月总支出」。
- 视觉风格：浅色主背景 + 品牌强调色，字体优先使用小程序默认字体，搭配 14/16/20 三级字号。
- 交互细节：添加订阅流程采用分步底部弹窗，支持从图库选择。
- 提供模板库（Surge、Netflix、Apple One、Spotify、腾讯视频、爱奇艺等）一键添加。

## 5. 功能需求

### 5.1 订阅管理

- 创建订阅：名称、价格、周期（月/季/年/自定义）、到期日、支付方式、Logo、备注。
- 编辑/删除/归档订阅项。
- 支持分类标签（娱乐、工具、教育等）与搜索过滤。
- 批量操作（多选归档/删除）。

### 5.2 提醒系统

- 微信订阅消息：到期前 1 天/3 天/自定义提醒。
- App 内红点/角标提示当日即将到期。
- 每月支出汇总推送（可选）。

### 5.3 数据与统计

- 月度/年度支出图表（条形或环图）。
- 订阅数量、即将到期数、已归档数。

### 5.4 账号与同步

- 基于微信 OpenID / UnionID 登录。
- 自建 Token 体系保障安全。

## 7. 技术架构

项目采用 monorepo 仓库同时存放客户端和服务端代码。

### 7.1 客户端

- 微信小程序原生框架，使用 TypeScript
- 状态管理：自定义 Hooks + 全局 store
- UI：定制化组件（基于原生组件 + 自定义样式），图表使用 F2 / ECharts 小程序版。

### 7.2 服务端

- Nest.js + MySQL
- REST API
- 使用 Prisma 管理数据模型。
- 定时任务
- 消息推送：调用微信订阅消息 API。

### 7.3 数据模型（初稿）

- `users`：id, open_id, union_id, phone(optional), created_at.
- `subscriptions`：id, user_id, name, logo_url, price, currency, cycle, next_due_date, category, notes, status.
- `notifications`：id, subscription_id, type, advance_days, last_sent_at.
- `audit_logs`：记录 CRUD 操作（可选）。

## 8. API 草案

| 方法   | 路径                            | 说明                           |
| ------ | ------------------------------- | ------------------------------ |
| POST   | `/auth/login`                   | 微信登录，返回 JWT/Session     |
| GET    | `/subscriptions`                | 查询用户订阅列表，支持筛选排序 |
| POST   | `/subscriptions`                | 新增订阅                       |
| GET    | `/subscriptions/{id}`           | 订阅详情                       |
| PATCH  | `/subscriptions/{id}`           | 更新订阅                       |
| DELETE | `/subscriptions/{id}`           | 删除/归档订阅                  |
| POST   | `/subscriptions/{id}/reminders` | 配置提醒                       |
| GET    | `/stats/summary`                | 统计数据                       |

接口都要求携带用户 Token；限制请求速率（如 60 req/min）。

## 9. 提醒与任务流程

1. 定时任务扫描  `next_due_date`，匹配到期 N 日内的条目。
2. 按用户订阅消息配置调用微信模板发送；失败时重试 3 次，记录日志。
3. 客户端在首页展示本日提醒列表；用户点击可跳转到详情页。

## 10. 后续拓展

- 自动识别邮件/账单、OCR 收据。
- 家庭共享与权限管理。
- Web / 桌面客户端。
- 第三方支付整合（支付宝、Apple Pay 订阅识别）。
