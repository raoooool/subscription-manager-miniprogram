# 瓜的订阅管理 · 客户端设计与施工方案

## 1. 项目概述

- **目标**：构建一款基于微信小程序的订阅管理客户端，实现 30 秒快速导入、清晰的资产盘点展示、智能提醒及美观易用的交互体验。
- **范围**：覆盖登录引导、订阅列表与详情、模板库、提醒配置、数据统计、设置中心等核心流程，并预留家庭共享与多端扩展能力。

## 2. 技术选型与整体架构

- **框架**：微信小程序原生 + TypeScript。
- **状态管理**：轻量全局 Store（基于自定义 Hooks + `Behavior`/`Component` mixins），结合本地缓存。
- **网络层**：封装 `httpClient`（Promise + 拦截器），统一处理鉴权、重试、错误提示。
- **组件体系**：原生组件二次封装 + 自定义 UI 组件库；图表使用 F2/ECharts 小程序版。
- **目录结构**（示例）：
  ```
  src/
    app.ts           // 全局初始化
    app.json         // 页面路由
    styles/          // 全局样式、主题变量
    utils/           // 工具方法、http 封装
    store/           // 状态管理
    services/        // API 封装
    components/      // 通用组件
    pages/           // 页面目录（home, add-subscription, stats 等）
  ```

## 3. 视觉与交互规范

- **整体风格**：浅色背景 + 品牌强调色（高饱和蓝绿系），保留留白；主字体使用小程序默认字体，字号 14/16/20。
- **布局原则**：首屏展示关键指标（即将到期、本月支出）；卡片式列表强调金额与到期日，支持快速操作（进入详情、归档、提醒配置）。
- **交互细节**：
  - 添加订阅流程采用底部弹窗分步：选择模板 → 填写信息 → 确认保存。
  - 列表支持滑动手势或长按操作（归档/删除/设置提醒）。
  - 数据统计页面提供时间范围切换（本月/本年/自定义）。
  - 设置提醒时提供日期选择器与提前天数滑块。
- **动效**：轻量过渡（渐隐/滑入），保证性能稳定。

## 4. 页面与组件设计

### 4.1 页面规划

- `pages/login`：授权登录，引导用户绑定微信；展示隐私协议。
- `pages/onboarding`：首登引导，展示模板一键导入入口。
- `pages/home`：展示订阅列表、即将到期模块、快捷入口；支持搜索与筛选。
- `pages/subscription/detail`：展示订阅信息、历史调整、开支曲线、提醒配置入口。
- `pages/subscription/edit`：通用于新增/编辑，分节填写（基础信息、周期/提醒、备注）。
- `pages/templates`：模板库展示与一键导入。
- `pages/stats`：图表展示月度/年度支出、分类占比、趋势。
- `pages/settings`：个人信息、提醒设置、隐私政策、反馈入口。

### 4.2 核心组件

- `SubscriptionCard`：展示名称/金额/到期/标签，支持手势操作。
- `ReminderBadge`：标记提醒状态，支持快速修改。
- `CycleSelector`：周期选择器，支持自定义天数。
- `PriceInput`：带货币符号与校验提示的输入框。
- `TemplateGrid`：模板列表展示，支持收藏与导入。
- `EmptyState`：空列表提示 + CTA。
- `FloatingActionButton`：右下角添加按钮。
- `Toast/Modal`：统一提示组件。
- `ChartView`：封装 F2/ECharts 图表组件，支持主题与缩略数据。

### 4.3 无障碍与适配

- 适配 iPhone 全尺寸、安卓主流机型；注意刘海屏安全区域。
- 开启文本缩放检测，关键文本保持可读性。
- 图表与颜色搭配保证色弱可区分（同时提供文字标签）。

## 5. 数据流与状态管理

- 全局 Store：用户信息、订阅缓存、提醒设置、统计数据、系统配置。
- 页面级状态：过滤条件、分页游标、表单临时值。
- 采用观察者模式监听 Store 更新，页面通过 `useStore` Hook 订阅数据。
- 本地缓存：进入首页时优先加载本地缓存，再异步刷新；关键数据每次更新同步写入 `wx.setStorage`。
- WebSocket/长轮询：预留实时提醒能力，目前以轮询实现（可后台任务触发）。

## 6. 网络与接口集成

- `httpClient` 封装：
  - 请求拦截：注入 `Authorization`，统一 `traceId`。
  - 响应拦截：处理 Token 过期（触发刷新或重新登录），错误统一提示。
  - 超时与重试策略：超时 8s，最多重试 1 次；部分接口配置不重试（如表单提交）。
- API Service 分层：`authService`、`subscriptionService`、`notificationService`、`statsService`、`templateService`。
- 网络失败降级：提供离线模式 → 展示缓存 + 提示刷新。

## 7. 表单与校验

- 使用自定义 Hook `useForm` 管理表单状态。
- 校验规则：名称必填（<= 30 字）、价格正数、周期合法（内置选项或自定义 1-999 天），到期日不得早于今天。
- 错误提示：输入框下方展示文字 + Shake 动效；顶部 Toast 显示严重错误。
- 自动保存草稿：编辑时自动缓存草稿，防止切换页面丢失。

## 8. 提醒与任务流程

- 客户端负责：
  - 展示今日提醒、到期标记。
  - 提供提醒配置 UI，将设定写回服务端。
  - 接收微信订阅消息跳转链接处理（通过 `scene` 参数定位订阅详情）。
- 本地提醒（可选）：使用 `wx.scheduleMessage` 预留能力，当前以服务端消息为主。

## 9. 性能优化

- 按需加载：分页加载订阅列表，滚动触底触发 `loadMore`。
- 虚拟列表：订阅数量较大场景使用虚拟渲染，减少节点。
- 图片优化：Logo 使用 CDN 裁剪，默认占位图；开启缓存。
- 数据缓存：统计数据 + 模板列表写入本地缓存，设置 TTL。
- 监控性能：利用 `wx.reportAnalytics` 上报接口耗时、页面加载时间。

## 10. 安全与隐私

- 授权前展示隐私政策；明确使用范围。
- 所有敏感操作（退出登录、删除订阅）提供确认弹窗。
- 数据最小化：本地缓存仅保存必要字段，退出登录清除。
- 防刷策略：关键接口请求前校验 Token，错误时清除会话并引导重新登录。

## 11. 测试与质量保障

- 单元测试：使用 `miniprogram-simulate` 或 `miniprogram-automator` 对组件和页面逻辑进行测试。
- 集成测试：模拟登录 + API 交互；Mock 服务端响应，验证页面行为。
- 交互测试：脚本化测试核心流程（导入模板、添加订阅、配置提醒）。
- 静态检查：ESLint、Stylelint、Prettier；Git Hooks 在提交前运行。

## 12. 构建与部署

- 构建脚本：`npm run build` 调用小程序编译；ci 检查测试、lint 后生成产物。
- CI/CD：GitHub Actions 对接微信小程序上传 API，生成预览/体验版二维码。
- 多环境：dev/test/prod 配置通过 `env-config.js` 注入，上传前选择对应环境。
- 版本管理：SemVer（MAJOR.MINOR.PATCH）；发布前执行冒烟测试清单。

## 13. 实施计划

| 阶段               | 时间          | 关键任务                                       |
| ------------------ | ------------- | ---------------------------------------------- |
| 阶段 0：准备       | T0 ~ T0+1w    | 搭建项目脚手架、定义组件规范、CI 初始化        |
| 阶段 1：基础框架   | T0+1w ~ T0+3w | 登录流程、全局状态、网络层、主题样式           |
| 阶段 2：订阅管理   | T0+3w ~ T0+5w | 首页列表、详情/编辑、模板导入、搜索筛选        |
| 阶段 3：提醒与统计 | T0+5w ~ T0+6w | 提醒配置 UI、今日提醒、统计图表、缓存优化      |
| 阶段 4：体验完善   | T0+6w ~ T0+7w | 动效优化、错误处理、空状态、无障碍与响应式适配 |
| 阶段 5：测试发布   | T0+7w ~ T0+8w | 自动化测试、体验版发布、性能与安全检查         |

## 14. 监控与运营支持

- 集成微信小程序数据助手，监控访问、留存、漏斗。
- 自定义埋点：关键操作（添加订阅、设置提醒）上报埋点，作为后续迭代依据。
- 问题反馈：设置反馈入口（跳转企业微信/客服），结合日志定位问题。
- 灰度发布：体验版邀请核心用户试用，逐步扩大范围。
